#
# OpenSIPS Configuration for sage-voice-manager
# Routes SIP calls to Python media server and anchors media through rtpengine
#

####### Global Parameters #########
log_level=4
debug_mode=yes
stderror_enabled=yes
syslog_facility=LOG_LOCAL0
mpath="/usr/lib/x86_64-linux-gnu/opensips/modules/"

socket=udp:0.0.0.0:5060
socket=tcp:0.0.0.0:5060

####### Load Modules ########
loadmodule "proto_udp.so"
loadmodule "proto_tcp.so"
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "sipmsgops.so"
loadmodule "rr.so"
loadmodule "rtpengine.so"

####### Module Parameters ########
modparam("rtpengine", "rtpengine_sock", "udp:${RTPENGINE_HOST}:${RTPENGINE_PORT}")

####### Helper Routes ########
route[relay] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

####### Main Routing Logic ########
route {
    # In-dialog requests
    if (has_totag()) {
        if (loose_route()) {
            if (is_method("BYE")) {
                rtpengine_delete();
            } else if (is_method("INVITE")) {
                if (!rtpengine_offer("replace-origin replace-session-connection ICE=force rtcp-mux-demux")) {
                    sl_send_reply(488, "Not Acceptable Here");
                    exit;
                }
                t_on_reply("INVITE_REPLY");
            }
            route(relay);
        }

        if (is_method("ACK")) {
            route(relay);
        }

        sl_send_reply(404, "Not here");
        exit;
    }

    if (is_method("OPTIONS")) {
        sl_send_reply(200, "OK");
        exit;
    }

    if (is_method("CANCEL")) {
        rtpengine_delete();
        t_relay();
        exit;
    }

    if (is_method("INVITE")) {
        record_route();

        # Insert rtpengine between RTP trunk and WebRTC service
        if (!rtpengine_offer("replace-origin replace-session-connection ICE=force rtcp-mux-demux")) {
            sl_send_reply(488, "Not Acceptable Here");
            exit;
        }
        t_on_reply("INVITE_REPLY");
    }

    # Forward initial requests toward the media service (WebRTC side)
    $du = "sip:${MEDIA_SERVER_HOST}:${MEDIA_SERVER_PORT}";
    route(relay);
}

onreply_route[INVITE_REPLY] {
    if (t_check_status("^[3-6][0-9][0-9]$")) {
        rtpengine_delete();
        exit;
    }

    if (!has_body("application/sdp")) {
        exit;
    }

    if (!rtpengine_answer("replace-origin replace-session-connection ICE=force rtcp-mux-demux")) {
        drop();
    }
}
