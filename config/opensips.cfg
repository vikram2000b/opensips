#
# OpenSIPS Configuration for sage-voice-manager
# Routes SIP calls to Python media server
#

####### Global Parameters #########
log_level=3
log_stderror=yes
log_facility=LOG_LOCAL0

listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060

disable_tcp=no
tcp_accept_aliases=yes
tcp_connection_lifetime=3600

dns_try_ipv6=no
auto_aliases=no

####### Modules Section ########
loadmodule "signaling.so"
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "mi_fifo.so"
loadmodule "proto_udp.so"
loadmodule "proto_tcp.so"

####### Module Parameters #########
modparam("mi_fifo", "fifo_name", "/tmp/opensips_fifo")
modparam("mi_fifo", "fifo_mode", 0666)
modparam("rr", "append_fromtag", 1)

####### Routing Logic ########
route {
    # Sanity checks
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    if (msg:len > 2048) {
        sl_send_reply("513", "Message Too Big");
        exit;
    }

    # Handle sequential requests
    if (has_totag()) {
        if (loose_route()) {
            t_relay();
            exit;
        }
    }

    # Handle CANCEL and ACK
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    if (is_method("ACK")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    # Record route for dialog-forming requests
    if (!is_method("REGISTER|MESSAGE")) {
        record_route();
    }

    # Forward all requests to media server
    # TODO: Replace with your media server's private DNS or IP
    $du = "sip:sage-media-server.local:80";

    xlog("L_INFO", "Routing $rm from $si to media server\n");

    if (!t_relay()) {
        sl_reply_error();
    }
}

failure_route[1] {
    xlog("L_INFO", "Call failed: $rs $rr\n");
}
